<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zeta Music Visualizer</title>
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">  <!-- Link to CSS -->
    <script src="{{ url_for('static', filename='js/MIDI.min.js') }}"></script>  <!-- Load local MIDI.js -->
</head>
<body>
    <div class="container">
        <h1>Zeta Music Visualizer</h1>
        <p>Enter the number of zeros to compute and generate the MIDI music. This process may take a while, depending on the number of zeros.</p>

        <form id="computeForm">
            <label for="numZeros">Number of Zeros:</label>
            <input type="number" id="numZeros" name="numZeros" min="1" max="10000" value="100" required>
            <button type="submit">Generate Music</button>
        </form>

        <div id="progressMessage" style="display: none;">
            <p>Generating the music... please wait.</p>
        </div>

        <div id="audioPlayerSection" style="display: none;">
            <p>Your music is ready!</p>
            <!-- Button to play the MIDI using MIDI.js -->
            <button id="playMusicButton" onclick="playMIDI()">Play Music</button>
        </div>
    </div>

    <script>
        let midiFileUrl = "";

        // Handle form submission and interact with the Flask backend
        document.getElementById("computeForm").addEventListener("submit", function(event) {
            event.preventDefault();

            // Get the number of zeros from the input field
            let numZeros = document.getElementById("numZeros").value;

            // Show progress message and hide the audio player
            document.getElementById("progressMessage").style.display = "block";
            document.getElementById("audioPlayerSection").style.display = "none";

            // Send request to Flask server to compute zeros
            fetch(`/compute_zeros?num=${numZeros}`)
                .then(response => response.blob())  // Get the path to the MIDI file
                .then(blob => {
                    // Create a URL for the audio file
                    const audioUrl = URL.createObjectURL(blob);
                    const audioSource = document.getElementById("audioSource");
                    audioSource.src = audioUrl;

                    // Show the audio player
                    document.getElementById("audioPlayerSection").style.display = "block";
                    document.getElementById("progressMessage").style.display = "none";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert("An error occurred while generating the music.");
                });
        });

        function playMIDI() {
            // Initialize MIDI.js with explicit Web Audio API settings
            MIDI.loadPlugin({
                soundfontUrl: "/static/soundfont.sf2",  // Load the local SoundFont from Flask's static folder
                instrument: "acoustic_grand_piano",
                onsuccess: function() {
                    MIDI.setOptions({
                        midiToNoteCallback: function() {}  // Disable any MIDI device handling
                    });

                    // Fetch the MIDI file and play it using MIDI.js
                    fetch(midiFileUrl)
                        .then(response => response.arrayBuffer())
                        .then(midiData => {
                            MIDI.Player.loadDataUri(midiData);
                            MIDI.Player.start();
                        })
                        .catch(err => {
                            console.error('Error loading MIDI file:', err);
                            alert('Failed to load MIDI file.');
                        });
                }
            });
        }
    </script>
</body>
</html>
